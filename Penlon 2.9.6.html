<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Penlon Nuffield 200 Ventilator Calculator v2.9.6</title>
</head>
<body style="font-family:Arial,sans-serif;max-width:650px;margin:20px auto;padding:20px;background:#f8f9fa;">

<!-- Designer badge (same position as before, more visible) -->
<div style="position:absolute;top:10px;right:10px;
            background:rgba(0,0,0,0.8);color:#fff;
            padding:6px 12px;border-radius:999px;
            font-size:12px;font-weight:600;
            box-shadow:0 2px 6px rgba(0,0,0,0.35);">
  Designed by Dr. Sabari Sundaresan
</div>

<div style="background:linear-gradient(135deg,#007cba 0%,#005a87 100%);color:white;padding:25px;border-radius:12px;margin-bottom:30px;text-align:center;">
  <h1 style="margin:0 0 5px 0;font-size:28px;">Penlon Nuffield 200</h1>
  <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">Ventilator Settings Calculator</div>
  <div style="background:rgba(255,255,255,0.3);padding:4px 12px;border-radius:20px;font-size:14px;font-weight:500;display:inline-block;">v2.9.6</div>
</div>

<div style="background:white;padding:30px;border-radius:12px;margin-bottom:20px;">

  <!-- Mode toggle -->
  <div style="margin-bottom:16px;font-weight:500;color:#555;">
    Mode:
    <label style="margin-left:10px;">
      <input type="radio" name="mode" value="normal" checked> Normal mode
    </label>
    <label style="margin-left:10px;">
      <input type="radio" name="mode" value="newton"> Newton valve mode
    </label>
  </div>
  <div style="font-size:12px;color:#888;margin-bottom:18px;line-height:1.4;">
    Normal mode assumes the standard patient valve. Newton valve mode is intended for use when the Newton valve is fitted; in this mode all tidal volumes are approximate and must be confirmed with spirometry, airway pressure monitoring and clinical judgement.
  </div>

  <label style="display:block;margin:18px 0;font-weight:500;color:#555;">
    Tidal Volume (ml)
    <span style="font-size:12px;color:#888;">[Validated range (normal mode): 50-2000 ml]</span>
    <br>
    <input type="number" id="vt" min="50" max="2000" step="50"
           style="width:100%;max-width:180px;padding:12px;border:2px solid #e1e5e9;border-radius:8px;font-size:16px;">
  </label>

  <label style="display:block;margin:18px 0;font-weight:500;color:#555;">
    Frequency (bpm)
    <span style="font-size:12px;color:#888;">[Validated range: 10-86 bpm]</span>
    <br>
    <input type="number" id="freq" min="10" max="86" step="1"
           style="width:100%;max-width:180px;padding:12px;border:2px solid #e1e5e9;border-radius:8px;font-size:16px;">
  </label>

  <label style="display:block;margin:18px 0;font-weight:500;color:#555;">
    I:E Ratio (Inspiration : Expiration)
    <span style="font-size:12px;color:#888;display:block;margin-top:2px;">
      Enter the E part only:
      1:1 -> 1,
      1:1.5 -> 1.5,
      1:2 -> 2,
      1:3 -> 3,
      1:4 -> 4,
      1:5 -> 5
    </span>
    <br>
    <input type="number" id="ier" value="2" min="1" max="5" step="0.5"
           style="width:100%;max-width:180px;padding:12px;border:2px solid #e1e5e9;border-radius:8px;font-size:16px;">
  </label>

  <button onclick="calculate()" 
          style="background:linear-gradient(135deg,#007cba 0%,#005a87 100%);color:white;padding:14px 32px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;width:100%;">
    CALCULATE SETTINGS
  </button>
</div>

<div id="result" style="display:none;background:white;padding:30px;border-radius:12px;"></div>

<script>
function getMode() {
  const radios = document.getElementsByName('mode');
  for (let r of radios) {
    if (r.checked) return r.value;
  }
  return 'normal';
}

function calculate() {
  let mode = getMode(); // "normal" or "newton"
  let vt_input_ml = parseFloat(document.getElementById('vt').value); // requested Vt (ml)
  let freq_input = parseFloat(document.getElementById('freq').value);
  let ier_input = parseFloat(document.getElementById('ier').value) || 2;

  if (!vt_input_ml || !freq_input || vt_input_ml < 50 || vt_input_ml > 2000 || freq_input < 10 || freq_input > 86) {
    alert('Use validated ranges: Tidal Volume 50-2000 ml and Frequency 10-86 bpm (per Nuffield 200 user manual).');
    return;
  }

  // Convert requested tidal volume to litres
  let vt_l = vt_input_ml / 1000;

  // ORIGINAL CALCULATION (using user-entered I:E)
  let ti = 60 / (freq_input * (1 + ier_input));
  // Clamp Ti to ventilator specified range 0.2–2.0 s
  let ti_clamp = Math.max(0.2, Math.min(2.0, ti));
  let flow = vt_l / ti_clamp;
  // Clamp flow to ventilator specified range 0.25–1.0 L/s
  let flow_clamp = Math.max(0.25, Math.min(1.0, flow));
  let te = ti_clamp * ier_input;
  let actual_freq = 60 / (ti_clamp + te);

  // Knob values as shown to user (rounded)
  let left_knob  = parseFloat(ti_clamp.toFixed(1));   // LEFT KNOB (Inspiratory Time, s)
  let front_knob = parseFloat(flow_clamp.toFixed(2)); // FRONT KNOB (Flow Rate, L/s)

  // Actual tidal volume from current knobs
  let actual_vt_ml = left_knob * front_knob * 1000;

  // Mismatch calculation
  let diff_ml = actual_vt_ml - vt_input_ml;
  let diff_pct = (diff_ml / vt_input_ml) * 100;

  // SEARCH FOR A BETTER COMBINATION (Ti, flow, I:E) NEAR THE REQUESTED RATE
  let candidateIEs = [1.0, 1.5, 2.0, 3.0]; // 1:1, 1:1.5, 1:2, 1:3
  let best = null;
  let maxFreqDrift = 2; // bpm allowed difference from requested

  for (let E of candidateIEs) {
    for (let ti_candidate = 0.2; ti_candidate <= 2.0 + 1e-6; ti_candidate += 0.1) {
      for (let flow_candidate = 0.25; flow_candidate <= 1.0 + 1e-6; flow_candidate += 0.05) {
        let vt_candidate_ml = ti_candidate * flow_candidate * 1000;
        let te_candidate = ti_candidate * E;
        let freq_candidate = 60 / (ti_candidate + te_candidate);

        if (Math.abs(freq_candidate - freq_input) > maxFreqDrift) continue;

        let dv = vt_candidate_ml - vt_input_ml;
        let absDiff = Math.abs(dv);

        if (!best || absDiff < best.absDiff) {
          best = {
            ti: ti_candidate,
            flow: flow_candidate,
            E: E,
            freq: freq_candidate,
            vt_ml: vt_candidate_ml,
            absDiff: absDiff
          };
        }
      }
    }
  }

  // Build suggestion HTML if mismatch is large AND a distinct better combo exists
  let suggestionHtml = '';
  if (Math.abs(diff_pct) > 10 && best) {
    let direction = diff_ml > 0 ? 'higher' : 'lower';
    let original_IE_text = '1:' + ier_input.toString();
    let suggested_IE_text = '1:' + best.E.toString();
    let freq_change = (best.freq - freq_input).toFixed(1);
    let te_suggested = best.ti * best.E;

    suggestionHtml += 
      '<div style="background:#fff3cd;padding:16px;border-radius:8px;border-left:4px solid #ffc107;margin:20px 0;font-size:14px;color:#856404;">' +
        '<b>Tidal volume mismatch notice</b><br>' +
        'Requested tidal volume: <b>' + vt_input_ml.toFixed(0) + ' ml</b>; ' +
        'estimated from current knob settings: <b>' + actual_vt_ml.toFixed(0) + ' ml</b> ' +
        '(<span>' + (diff_ml>0?'+':'') + diff_ml.toFixed(0) + ' ml, ' + diff_pct.toFixed(1) + '% ' + direction + '</span>).' +
      '</div>';

    let tiDiff = Math.abs(best.ti - left_knob);
    let flowDiff = Math.abs(best.flow - front_knob);
    let eDiff = Math.abs(best.E - ier_input);

    if (tiDiff > 0.05 || flowDiff > 0.05 || eDiff > 0.1) {
      suggestionHtml +=
        '<div style="background:#eef6ff;padding:16px;border-radius:8px;border-left:4px solid #007cba;margin:10px 0;font-size:13px;color:#004085;line-height:1.6;">' +
          '<b>Suggested alternative settings to better match target tidal volume:</b>' +
          '<ul style="margin:8px 0 0 18px;padding:0;">' +
            '<li>Set <b>LEFT KNOB</b> (Inspiratory Time) to approximately <b>' + best.ti.toFixed(1) + ' s</b>.</li>' +
            '<li>Set <b>FRONT KNOB</b> (Flow Rate) to approximately <b>' + best.flow.toFixed(2) + ' L/s</b>.</li>' +
            '<li>Set <b>RIGHT KNOB</b> (Expiratory Time) to approximately <b>' + te_suggested.toFixed(1) + ' s</b>.</li>' +
            '<li>This corresponds to an I:E ratio of approximately <b>' + suggested_IE_text + '</b> ' +
              '(your original I:E was <b>' + original_IE_text + '</b>).</li>' +
            '<li>With these values, estimated tidal volume ≈ <b>' + best.vt_ml.toFixed(0) + ' ml</b> ' +
              'and frequency ≈ <b>' + best.freq.toFixed(1) + ' bpm</b> ' +
              '(original frequency request: <b>' + freq_input.toFixed(1) + ' bpm</b>; change ' +
              (freq_change>0?'+':'') + freq_change + ' bpm).</li>' +
            '<li>Always confirm tidal volume, minute volume and patient response on the ventilator and spirometer/ETCO₂, and adjust as needed.</li>' +
          '</ul>' +
        '</div>';
    }
  }

  // Mode-specific warning note
  let modeNote = '';
  if (mode === 'newton') {
    modeNote = '<div style="background:#fde2e4;padding:14px;border-radius:8px;border-left:4px solid #c82333;font-size:12px;margin-bottom:10px;">' +
               '<b>Newton valve mode:</b> With the Newton valve and T-piece system, actual delivered tidal volume is strongly influenced by leaks, circuit compliance, and fresh-gas flow. Treat all volumes shown here as approximate only and rely on spirometry, airway pressure and clinical monitoring for final adjustment.' +
               '</div>';
  }

  // Quick ETCO₂ tweaking footnote (small text, to be appended last)
  let etco2Note =
    '<div style="background:#f8f9fa;padding:10px 15px;border-radius:8px;border-left:3px solid #17a2b8;font-size:11px;line-height:1.6;margin-top:10px;">' +
      '<b>Quick guide for ETCO₂ adjustments (single‑knob changes)</b><br>' +
      '• To primarily change <b>frequency</b> (bpm): adjust the <b>RIGHT KNOB</b> (Expiratory Time). Shortening expiratory time increases frequency; lengthening expiratory time reduces frequency, with inspiratory time and flow kept constant.<br>' +
      '• To primarily change <b>tidal volume</b> (ml): adjust the <b>FRONT KNOB</b> (Flow Rate). Increasing flow increases tidal volume; reducing flow decreases tidal volume, with inspiratory time kept constant.<br>' +
      '<b>Important:</b> These are simplified, single‑knob strategies for fine‑tuning ETCO₂. Actual minute ventilation and CO₂ depend on the combination of tidal volume, frequency, circuit compliance, leaks, fresh‑gas flow and patient factors. Always confirm changes with airway pressure, spirometry, ETCO₂ trends and full clinical assessment, and follow your local protocols and the Penlon Nuffield 200 User Manual.' +
    '</div>';

  document.getElementById('result').innerHTML = 
    modeNote +
    '<div style="background:#f0f7ff;padding:20px;border-radius:8px;border-left:4px solid #007cba;margin:20px 0;">'+
      '<h3 style="margin-top:0;color:#007cba;">SETTING KNOB POSITIONS (FROM YOUR INPUTS)</h3>'+
      '<div style="display:inline-block;background:white;padding:12px 20px;margin:8px;border-radius:6px;font-weight:600;min-width:140px;text-align:center;">'+
        '<div style="font-size:14px;color:#666;margin-bottom:4px;">LEFT KNOB<br><small>(Inspiratory Time)</small></div>'+
        '<span style="font-size:20px;color:#007cba;">'+left_knob.toFixed(1)+'s</span>'+
      '</div>'+
      '<div style="display:inline-block;background:white;padding:12px 20px;margin:8px;border-radius:6px;font-weight:600;min-width:140px;text-align:center;">'+
        '<div style="font-size:14px;color:#666;margin-bottom:4px;">FRONT KNOB<br><small>(Flow Rate)</small></div>'+
        '<span style="font-size:20px;color:#28a745;">'+front_knob.toFixed(2)+' L/s</span>'+
      '</div>'+
      '<div style="display:inline-block;background:white;padding:12px 20px;margin:8px;border-radius:6px;font-weight:600;min-width:140px;text-align:center;">'+
        '<div style="font-size:14px;color:#666;margin-bottom:4px;">RIGHT KNOB<br><small>(Expiratory Time)</small></div>'+
        '<span style="font-size:20px;color:#ffc107;">'+te.toFixed(1)+'s</span>'+
      '</div>'+
      '<div style="display:inline-block;background:white;padding:12px 20px;margin:8px;border-radius:6px;font-weight:600;min-width:140px;text-align:center;">'+
        '<div style="font-size:14px;color:#666;margin-bottom:4px;">Result<br><small>(Actual Frequency)</small></div>'+
        '<span style="font-size:20px;color:#dc3545;">'+actual_freq.toFixed(0)+' bpm</span>'+
      '</div>'+
      '<div style="display:inline-block;background:white;padding:12px 20px;margin:8px;border-radius:6px;font-weight:600;min-width:140px;text-align:center;">'+
        '<div style="font-size:14px;color:#666;margin-bottom:4px;">Result<br><small>(Actual Tidal Volume)</small></div>'+
        '<span style="font-size:20px;color:#17a2b8;">'+actual_vt_ml.toFixed(0)+' ml</span>'+
      '</div>'+
    '</div>' +
    suggestionHtml +
    '<div style="color:#666;margin:20px 0;line-height:1.8;">'+
      '<ol style="padding-left:20px;margin:10px 0;">'+
        '<li>Occlude patient port less than or equal to 60 cmH2O.</li>'+
        '<li>Monitor spirometer/ETCO2.</li>'+
        '<li>Add 10-20% for circuit compliance.</li>'+
      '</ol>'+
    '</div>'+
    '<div style="background:linear-gradient(90deg,#fee 0%,#fcc 100%);padding:20px;border-radius:8px;border-left:5px solid #dc3545;margin:20px 0;">'+
      '<b>WARNING:</b> This calculator is for educational support only. Always bench-test settings on the actual ventilator, and base all clinical decisions on the ventilator user manual and your local protocols.'+
    '</div>'+
    '<div style="background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #6c757d;font-size:13px;">'+
      '<b>Note:</b> Parameter ranges and the relation between inspiratory time, flow and tidal volume reflect the specifications in the Penlon Nuffield 200 User Manual (2000 edition). Use this calculator as a learning aid only, and always confirm settings against the ventilator and local clinical protocols.'+
    '</div>' +
    etco2Note;

  document.getElementById('result').style.display = 'block';
}
</script>
</body>
</html>